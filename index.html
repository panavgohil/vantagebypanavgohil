<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vantage Finance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f172a; --card-bg: #1e293b; --primary: #3b82f6;
            --accent: #10b981; --danger: #ef4444; --text-main: #f8fafc;
            --text-sub: #94a3b8; --input-bg: #334155;
            --gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --loan-color: #8b5cf6;
        }
        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; display: flex; justify-content: center; align-items: center; }

        /* LOADING */
        #loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .spinner { width:50px; height:50px; border:4px solid rgba(255,255,255,0.1); border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

        /* LAYOUT */
        .auth-container { width:100%; max-width:420px; padding:2.5rem; background:var(--card-bg); border-radius:20px; border:1px solid rgba(255,255,255,0.05); box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .dashboard-wrapper { display:none; width:100%; max-width:1200px; padding:20px; grid-template-columns:1.5fr 1fr; gap:25px; height:90vh; }
        @media (max-width:850px) { .dashboard-wrapper { grid-template-columns:1fr; height:auto; } }
        .dash-card { background:var(--card-bg); border-radius:20px; padding:25px; border:1px solid rgba(255,255,255,0.05); overflow-y:auto; }

        /* BRANDING */
        .brand-wrapper { text-align: center; margin-bottom: 30px; }
        .app-title { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 12px; background: linear-gradient(135deg, #fff 20%, #94a3b8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-subtitle { font-family: 'Inter', sans-serif; font-size: 0.75rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 3px; margin-top: 5px; opacity: 0.8; }

        /* UI ELEMENTS */
        .role-wrapper { margin-bottom: 25px; text-align: center; }
        .role-label { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .role-selector { display:flex; background:var(--bg-color); padding:5px; border-radius:10px; border: 1px solid var(--input-bg); }
        .role-opt { flex:1; text-align:center; padding:10px; border-radius:8px; cursor:pointer; font-size:0.95rem; color:var(--text-sub); }
        .role-opt.active { background:var(--input-bg); color:white; font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.2); border: 1px solid var(--primary); }

        .auth-tabs { display:flex; margin-bottom:25px; border-bottom:2px solid var(--input-bg); }
        .auth-tab { flex:1; text-align:center; padding:15px; cursor:pointer; font-weight:600; color:var(--text-sub); }
        .auth-tab.active { color:var(--primary); border-bottom:2px solid var(--primary); margin-bottom:-2px; }

        .input-group { position:relative; margin-bottom:15px; }
        .input-group i { position:absolute; left:15px; top:50%; transform:translateY(-50%); color:var(--text-sub); }
        input, select { width:100%; padding:14px 14px 14px 45px; background:var(--input-bg); border:1px solid transparent; border-radius:12px; color:white; font-size:0.95rem; outline:none; }
        input:focus { border-color:var(--primary); background:#1e293b; }
        
        button { width:100%; padding:14px; border:none; border-radius:12px; background:var(--primary); color:white; font-weight:600; cursor:pointer; margin-top:10px; font-size:1rem; }
        button:hover { filter:brightness(1.1); }
        button.secondary { background:transparent; border:1px solid var(--input-bg); color:var(--text-sub); margin-top:10px; }

        /* DASHBOARD ELEMENTS */
        .total-card { background:var(--gradient); padding:25px; border-radius:20px; color:white; text-align:center; margin-bottom:25px; position:relative; overflow:hidden; }
        .total-amount { font-size:2.5rem; font-weight:700; display:block; margin:10px 0; }
        
        .dash-toggle { display:flex; background:var(--bg-color); border-radius:12px; padding:5px; margin-bottom:20px; }
        .dash-opt { flex:1; text-align:center; padding:10px; cursor:pointer; border-radius:8px; color:var(--text-sub); font-size:0.9rem; font-weight:600; }
        .dash-opt.active { background:var(--input-bg); color:white; }

        .expense-item { background:var(--bg-color); padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid var(--primary); }
        .expense-item.reimburse { border-left-color:var(--accent); }
        .expense-item.loan { border-left-color:var(--loan-color); } /* Purple for Loans */

        .status-badge { font-size:0.75rem; padding:4px 10px; border-radius:20px; }
        .status-Approved, .status-Repaid { background:rgba(16,185,129,0.2); color:#10b981; }
        .status-Rejected { background:rgba(239,68,68,0.2); color:#ef4444; }
        .status-Pending, .status-Given { background:rgba(245,158,11,0.2); color:#f59e0b; }
        
        .btn-export { background:rgba(16,185,129,0.15); color:var(--accent); padding:6px 12px; border-radius:8px; border:none; cursor:pointer; }
        .btn-check { background:rgba(16,185,129,0.2); color:#10b981; width:30px; height:30px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; }

        .hidden { display:none !important; }
        .step-indicator { font-size:0.8rem; color:var(--text-sub); margin-bottom:10px; text-align:right; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="hidden"><div class="spinner"></div></div>

    <div class="auth-container" id="authSection">
        <div class="brand-wrapper">
            <h2 class="app-title"><i class="fa-solid fa-chart-line" style="color:var(--primary); font-size:0.8em;"></i> Vantage</h2>
            <div class="brand-subtitle">by Panav Gohil</div>
        </div>
        
        <div class="role-wrapper">
            <span class="role-label">Login as</span>
            <div class="role-selector">
                <div id="role-student" class="role-opt active" onclick="setGlobalRole('student')">Student</div>
                <div id="role-guardian" class="role-opt" onclick="setGlobalRole('guardian')">Guardian</div>
            </div>
        </div>

        <div class="auth-tabs">
            <div id="tabLogin" class="auth-tab active" onclick="switchTab('login')">Sign In</div>
            <div id="tabRegister" class="auth-tab" onclick="switchTab('register')">Sign Up</div>
        </div>

        <div id="loginForm">
            <div class="input-group"><i class="fa-solid fa-envelope"></i><input type="email" id="l-email" placeholder="Email Address"></div>
            <div class="input-group"><i class="fa-solid fa-lock"></i><input type="password" id="l-password" placeholder="Password"></div>
            <button onclick="doLogin()">Login</button>
        </div>

        <div id="registerForm" class="hidden">
            <div id="reg-step-1">
                <div class="step-indicator">Step 1 of 3</div>
                <div class="input-group"><i class="fa-solid fa-envelope"></i><input type="email" id="r-email" placeholder="Enter your email"></div>
                <button onclick="sendOtp()">Send Verification Code</button>
            </div>
            <div id="reg-step-2" class="hidden">
                <div class="step-indicator">Step 2 of 3</div>
                <p style="color:var(--text-sub); text-align:center; font-size:0.9rem;">Code sent to email.</p>
                <div class="input-group"><i class="fa-solid fa-key"></i><input type="text" id="r-otp" placeholder="Enter 4-digit Code"></div>
                <button onclick="verifyOtp()">Verify Code</button>
                <button class="secondary" onclick="resetReg()">Back</button>
            </div>
            <div id="reg-step-3" class="hidden">
                <div class="step-indicator">Step 3 of 3</div>
                <div class="input-group"><i class="fa-solid fa-user"></i><input type="text" id="r-name" placeholder="Full Name"></div>
                <div class="input-group"><i class="fa-solid fa-lock"></i><input type="password" id="r-password" placeholder="Create Password"></div>
                <div class="input-group hidden" id="r-guardian-field"><i class="fa-solid fa-link"></i><input type="text" id="r-student-key" placeholder="Student Key (Required)"></div>
                <button onclick="doRegister()">Create Account</button>
            </div>
        </div>
        <p id="authMsg" style="color:var(--danger); text-align:center; margin-top:15px; min-height:20px;"></p>
    </div>

    <div class="dashboard-wrapper" id="dashboardSection">
        <div class="dash-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 id="dashTitle" style="margin:0; font-family:'Playfair Display', serif;">Dashboard</h3>
                <button onclick="logout()" style="width:auto; padding:8px 15px; background:var(--danger);">Logout</button>
            </div>

            <div id="dashToggle" class="dash-toggle hidden">
                <div id="mode-spend" class="dash-opt active" onclick="setDashMode('spend')">Spending</div>
                <div id="mode-lend" class="dash-opt" onclick="setDashMode('lend')">Lending (Friends)</div>
            </div>

            <div id="section-spend">
                <div id="studentControls" class="hidden">
                    <div style="background:#0f172a; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.05);">
                        <h4 style="margin:0 0 10px 0;">Add Expense</h4>
                        <div class="input-group"><i class="fa-solid fa-tag"></i><input id="expItem" placeholder="Item Name"></div>
                        <div style="display:flex; gap:10px;">
                            <div class="input-group"><i class="fa-solid fa-indian-rupee-sign"></i><input type="number" id="expAmount" placeholder="Amount"></div>
                            <div class="input-group"><i class="fa-solid fa-list"></i>
                                <select id="expCategory" style="padding-left:45px;">
                                    <option>Essentials</option><option>Food</option><option>Travel</option><option>Study</option>
                                    <option>Rent</option><option>Utilities</option><option>Health</option><option>Fashion</option>
                                    <option>Entertainment</option><option>Others</option>
                                </select>
                            </div>
                        </div>
                        <label style="color:var(--text-sub); display:flex; align-items:center; gap:10px; cursor:pointer;">
                            <input type="checkbox" id="expReimburse" style="width:18px; margin:0;"> Request Reimbursement
                        </label>
                        <button onclick="addExpense()">Save Expense</button>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h4>Recent Activity</h4>
                    <button class="btn-export" onclick="exportToExcel()"><i class="fa-solid fa-download"></i> CSV</button>
                </div>
                <div id="expenseList">Loading...</div>
            </div>

            <div id="section-lend" class="hidden">
                <div style="background:#0f172a; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid var(--loan-color);">
                    <h4 style="margin:0 0 10px 0; color:var(--loan-color);">Add New Loan</h4>
                    <div class="input-group"><i class="fa-solid fa-user-group"></i><input id="loanName" placeholder="Friend's Name"></div>
                    <div class="input-group"><i class="fa-solid fa-calendar"></i><input type="date" id="loanDate"></div>
                    <div class="input-group"><i class="fa-solid fa-indian-rupee-sign"></i><input type="number" id="loanAmount" placeholder="Amount Given"></div>
                    <button style="background:var(--loan-color);" onclick="addLoan()">Record Loan</button>
                </div>
                <h4>Active Loans</h4>
                <div id="loanList">Loading...</div>
            </div>

        </div>

        <div class="dash-card">
            <div class="total-card">
                <span style="opacity:0.8; font-size:0.9rem;">TOTAL SPENT</span>
                <span class="total-amount" id="grandTotal">₹0</span>
            </div>
            <h4 style="text-align:center;">Analysis</h4>
            <div style="height:250px; position:relative;"><canvas id="expenseChart"></canvas></div>
            <div id="chartLegend" style="margin-top:20px;"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyDC0RkfvP0BIWuPymhUl9xbLeu9lPkkBIVadUQBmIgbdwintGIP5cd-gs3T-BZNNKt/exec'; // REPLACE

        let currentRole = 'student', currentUser = null, currentExpenses = [], myChart = null;

        const loader = { show: () => document.getElementById('loader-overlay').classList.remove('hidden'), hide: () => document.getElementById('loader-overlay').classList.add('hidden') };
        const msg = (text) => document.getElementById('authMsg').innerText = text;

        function setGlobalRole(r) { currentRole = r; document.getElementById('role-student').classList.toggle('active', r==='student'); document.getElementById('role-guardian').classList.toggle('active', r==='guardian'); document.getElementById('r-guardian-field').classList.toggle('hidden', r!=='guardian'); msg(""); }
        function switchTab(t) { document.getElementById('tabLogin').classList.toggle('active', t==='login'); document.getElementById('tabRegister').classList.toggle('active', t==='register'); document.getElementById('loginForm').classList.toggle('hidden', t!=='login'); document.getElementById('registerForm').classList.toggle('hidden', t!=='register'); msg(""); }
        function resetReg() { document.getElementById('reg-step-1').classList.remove('hidden'); document.getElementById('reg-step-2').classList.add('hidden'); document.getElementById('reg-step-3').classList.add('hidden'); msg(""); }

        // --- DASHBOARD MODES ---
        function setDashMode(mode) {
            document.getElementById('mode-spend').classList.toggle('active', mode==='spend');
            document.getElementById('mode-lend').classList.toggle('active', mode==='lend');
            document.getElementById('section-spend').classList.toggle('hidden', mode!=='spend');
            document.getElementById('section-lend').classList.toggle('hidden', mode!=='lend');
            
            if(mode === 'lend') fetchLoans();
        }

        async function doLogin() {
            const email = document.getElementById('l-email').value, pass = document.getElementById('l-password').value;
            if(!email||!pass) return msg("Enter credentials");
            const res = await apiCall({ action:'login', role:currentRole, email:email, password:pass });
            if(res.status==='success') { localStorage.setItem('vantageUser', JSON.stringify({...res.data, role:currentRole})); loadDashboard({...res.data, role:currentRole}); } else msg(res.message);
        }

        async function sendOtp() {
            const email = document.getElementById('r-email').value; if(!email) return msg("Enter email");
            msg("Sending OTP..."); const res = await apiCall({ action:'send_otp', email:email });
            if(res.status==='success') { msg(""); document.getElementById('reg-step-1').classList.add('hidden'); document.getElementById('reg-step-2').classList.remove('hidden'); } else msg("Error");
        }
        async function verifyOtp() {
            const res = await apiCall({ action:'verify_otp', email:document.getElementById('r-email').value, otp:document.getElementById('r-otp').value });
            if(res.status==='success') { msg(""); document.getElementById('reg-step-2').classList.add('hidden'); document.getElementById('reg-step-3').classList.remove('hidden'); } else msg("Invalid OTP");
        }
        async function doRegister() {
            const email = document.getElementById('r-email').value, pass = document.getElementById('r-password').value, name = document.getElementById('r-name').value, key = document.getElementById('r-student-key').value;
            if(!name||!pass) return msg("Fill all fields");
            if(currentRole==='guardian' && !key) return msg("Enter Student Key");
            const action = currentRole==='student'?'register_student':'register_guardian';
            const res = await apiCall({ action:action, email:email, password:pass, name:name, studentKeys:key });
            if(res.status==='success') { alert(currentRole==='student'?"Account Created! Check email for key.":"Account Created!"); switchTab('login'); resetReg(); } else msg(res.message);
        }

        async function apiCall(data) { loader.show(); try { const res = await fetch(API_URL, {method:'POST', body:JSON.stringify(data)}); const json = await res.json(); loader.hide(); return json; } catch(e) { loader.hide(); alert("Connection Error"); return {status:'error'}; } }

        window.onload = function() { const saved = localStorage.getItem('vantageUser'); if(saved) loadDashboard(JSON.parse(saved)); };
        function logout() { localStorage.removeItem('vantageUser'); location.reload(); }

        function loadDashboard(user) {
            currentUser = user;
            document.getElementById('authSection').style.display='none'; document.getElementById('dashboardSection').style.display='grid';
            document.getElementById('dashTitle').innerText = `Hi, ${user.name.split(' ')[0]}`;
            if(user.role === 'student') {
                document.getElementById('studentControls').classList.remove('hidden');
                document.getElementById('dashToggle').classList.remove('hidden');
                fetchData(user.student_key, 'get_expenses');
            } else {
                fetchData(user.email, 'get_guardian_data');
            }
        }

        async function addExpense() {
            await apiCall({ action:'add_expense', student_key:currentUser.student_key, item_name:document.getElementById('expItem').value, amount:document.getElementById('expAmount').value, category:document.getElementById('expCategory').value, is_reimbursable:document.getElementById('expReimburse').checked });
            document.getElementById('expItem').value=""; document.getElementById('expAmount').value="";
            fetchData(currentUser.student_key, 'get_expenses');
        }

        async function addLoan() {
            const name = document.getElementById('loanName').value, amount = document.getElementById('loanAmount').value, date = document.getElementById('loanDate').value;
            if(!name || !amount) return alert("Fill details");
            await apiCall({ action:'add_loan', student_key:currentUser.student_key, friend_name:name, amount:amount, date:date });
            document.getElementById('loanName').value=""; document.getElementById('loanAmount').value="";
            fetchLoans();
        }

        async function updateStatus(id, stat) { await apiCall({ action:'update_status', expense_id:id, new_status:stat }); fetchData(currentUser.email, 'get_guardian_data'); }
        async function settleLoan(id) { if(confirm("Mark as repaid?")) { await apiCall({ action:'settle_loan', loan_id:id }); fetchLoans(); } }

        async function fetchData(id, action) {
            const res = await apiCall({ action:action, [action==='get_expenses'?'student_key':'email']:id });
            currentExpenses = res.expenses || []; renderList(currentExpenses); renderStats(currentExpenses);
        }
        async function fetchLoans() {
            const res = await apiCall({ action:'get_loans', student_key:currentUser.student_key });
            const list = document.getElementById('loanList'); list.innerHTML="";
            const loans = res.loans || [];
            if(!loans.length) list.innerHTML="<p style='color:#666'>No active loans.</p>";
            loans.reverse().forEach(l => {
                const isRepaid = l.status === 'Repaid';
                const btn = !isRepaid ? `<button class="btn-check" onclick="settleLoan('${l.id}')"><i class="fa fa-check"></i></button>` : '';
                list.innerHTML += `<div class="expense-item loan"><div><strong>${l.friend}</strong><br><span style="color:#888;font-size:0.8rem">${new Date(l.date).toLocaleDateString()}</span></div><div style="text-align:right; display:flex; gap:10px; align-items:center;"><strong>₹${l.amount}</strong><span class="status-badge status-${l.status}">${l.status}</span>${btn}</div></div>`;
            });
        }

        function renderList(items) {
            const list = document.getElementById('expenseList'); list.innerHTML="";
            if(!items.length) return list.innerHTML="<p style='text-align:center;color:#666'>No records.</p>";
            items.reverse().forEach(i => {
                let btns = (currentUser.role === 'guardian' && i.status === 'Pending') ? `<div style="margin-top:5px;"><button onclick="updateStatus('${i.id}','Approved')" style="width:30px;padding:5px;margin-right:5px;background:rgba(16,185,129,0.2);color:#10b981"><i class="fa fa-check"></i></button><button onclick="updateStatus('${i.id}','Rejected')" style="width:30px;padding:5px;background:rgba(239,68,68,0.2);color:#ef4444"><i class="fa fa-times"></i></button></div>` : '';
                list.innerHTML += `<div class="expense-item ${i.reimbursable||currentUser.role==='guardian'?'reimburse':''}"><div><strong>${i.item}</strong><div style="font-size:0.8rem;color:#888">${currentUser.role==='guardian'?i.studentName:i.category} • ${new Date(i.date).toLocaleDateString()}</div></div><div style="text-align:right"><strong>₹${i.amount}</strong><br>${(i.reimbursable||currentUser.role==='guardian')?`<span class="status-badge status-${i.status}">${i.status}</span>`:''}${btns}</div></div>`;
            });
        }

        function renderStats(items) {
            let total=0; const cats={};
            items.forEach(i => { total+= +i.amount; cats[i.category||'Misc']=(cats[i.category||'Misc']||0)+ +i.amount; });
            document.getElementById('grandTotal').innerText = `₹${total.toLocaleString()}`;
            if(myChart) myChart.destroy();
            const ctx = document.getElementById('expenseChart');
            const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f43f5e', '#64748b'];
            myChart = new Chart(ctx, { type:'doughnut', data: { labels:Object.keys(cats), datasets:[{data:Object.values(cats), backgroundColor:colors, borderWidth:0}] }, options:{plugins:{legend:{display:false}}} });
            document.getElementById('chartLegend').innerHTML = Object.keys(cats).map((c,i) => `<div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9rem"><span style="color:${colors[i%colors.length]}">● ${c}</span><span>₹${cats[c]}</span></div>`).join('');
        }

        function exportToExcel() {
            if(!currentExpenses.length) return alert("No data");
            let csv = "Date,Item,Category,Amount,Status\n" + currentExpenses.map(r => `${new Date(r.date).toLocaleDateString()},${r.item},${r.category},${r.amount},${r.status||'Pending'}`).join("\n");
            const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = "Expenses.csv"; link.click();
        }
    </script>
</body>
</html>