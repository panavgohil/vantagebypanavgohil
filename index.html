<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vantage Finance</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìà</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f172a; --card-bg: #1e293b; --primary: #3b82f6;
            --accent: #10b981; --danger: #ef4444; --text-main: #f8fafc;
            --text-sub: #94a3b8; --input-bg: #334155;
            --gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --loan-given: #8b5cf6; --loan-taken: #f97316;
        }
        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; display: flex; justify-content: center; align-items: center; -webkit-tap-highlight-color: transparent; }

        #loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .spinner { width:50px; height:50px; border:4px solid rgba(255,255,255,0.1); border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

        .auth-container { width:100%; max-width:420px; padding:2.5rem; background:var(--card-bg); border-radius:20px; border:1px solid rgba(255,255,255,0.05); box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .dashboard-wrapper { display:none; width:100%; max-width:1200px; padding:20px; grid-template-columns:1.5fr 1fr; gap:25px; height:90vh; }
        @media (max-width:850px) { .dashboard-wrapper { grid-template-columns:1fr; height:auto; } }
        .dash-card { background:var(--card-bg); border-radius:20px; padding:25px; border:1px solid rgba(255,255,255,0.05); overflow-y:auto; position: relative; }

        .brand-wrapper { text-align: center; margin-bottom: 30px; }
        .app-title { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 12px; background: linear-gradient(135deg, #fff 20%, #94a3b8 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-subtitle { font-family: 'Inter', sans-serif; font-size: 0.75rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 3px; margin-top: 5px; opacity: 0.8; }

        .dash-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .profile-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; cursor: pointer; border: 2px solid rgba(255,255,255,0.2); overflow: hidden; background-size: cover; background-position: center; }
        .profile-modal { position: absolute; top: 70px; right: 20px; width: 320px; background: #252e42; border-radius: 16px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); z-index: 100; display: none; flex-direction: column; align-items: center; }
        .profile-modal.show { display: flex; }
        .modal-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--input-bg); margin-bottom: 10px; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: var(--text-sub); cursor: pointer; position: relative; background-size: cover; background-position: center; border: 2px dashed var(--text-sub); }
        .modal-section { width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 10px; }
        .modal-label { font-size: 0.75rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .modal-value { background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; color: #fff; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .copy-btn { background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 0.9rem; }
        .logout-btn-modal { width: 100%; background: rgba(239, 68, 68, 0.1); color: var(--danger); margin-top: 15px; border: 1px solid rgba(239, 68, 68, 0.3); }

        .role-wrapper { margin-bottom: 25px; text-align: center; }
        .role-selector { display:flex; background:var(--bg-color); padding:5px; border-radius:10px; border: 1px solid var(--input-bg); }
        .role-opt { flex:1; text-align:center; padding:10px; border-radius:8px; cursor:pointer; font-size:0.95rem; color:var(--text-sub); }
        .role-opt.active { background:var(--input-bg); color:white; font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.2); border: 1px solid var(--primary); }

        .auth-tabs { display:flex; margin-bottom:25px; border-bottom:2px solid var(--input-bg); }
        .auth-tab { flex:1; text-align:center; padding:15px; cursor:pointer; font-weight:600; color:var(--text-sub); }
        .auth-tab.active { color:var(--primary); border-bottom:2px solid var(--primary); margin-bottom:-2px; }

        .input-group { position:relative; margin-bottom:15px; }
        .input-group .icon-left { position:absolute; left:15px; top:50%; transform:translateY(-50%); color:var(--text-sub); }
        .input-group .icon-right { position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-sub); cursor:pointer; }
        input, select, textarea { width:100%; padding:14px 45px 14px 45px; background:var(--input-bg); border:1px solid transparent; border-radius:12px; color:white; font-size:16px !important; outline:none; }
        input:focus { border-color:var(--primary); background:#1e293b; }
        
        button { width:100%; padding:14px; border:none; border-radius:12px; background:var(--primary); color:white; font-weight:600; cursor:pointer; margin-top:10px; font-size:1rem; }
        button:hover { filter:brightness(1.1); }
        button.secondary { background:transparent; border:1px solid var(--input-bg); color:var(--text-sub); margin-top:10px; }
        button.text-btn { background:transparent; color:var(--primary); width:auto; padding:5px 10px; font-size:0.9rem; margin-top:0; border:none; text-decoration:underline; }

        .forgot-link { display:block; text-align:right; font-size:0.85rem; color:var(--text-sub); text-decoration:none; margin-top:-10px; margin-bottom:15px; cursor:pointer; }
        
        .total-card { background:var(--gradient); padding:25px; border-radius:20px; color:white; text-align:center; margin-bottom:25px; position:relative; overflow:hidden; }
        .total-amount { font-size:2.5rem; font-weight:700; display:block; margin:10px 0; }
        .dash-toggle { display:flex; background:var(--bg-color); border-radius:12px; padding:5px; margin-bottom:20px; }
        .dash-opt { flex:1; text-align:center; padding:10px; cursor:pointer; border-radius:8px; color:var(--text-sub); font-size:0.9rem; font-weight:600; }
        .dash-opt.active { background:var(--input-bg); color:white; }

        .loan-tabs { display:flex; gap:10px; margin-bottom:15px; }
        .loan-tab { flex:1; padding:12px; text-align:center; border-radius:10px; border:1px solid var(--input-bg); cursor:pointer; font-size:0.9rem; color:var(--text-sub); font-weight:600; }
        .loan-tab.active { background:var(--input-bg); color:white; }

        .month-header { color: var(--text-sub); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .expense-item { background:var(--bg-color); padding:15px; border-radius:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid var(--primary); }
        .expense-item.reimburse { border-left-color:var(--accent); }
        .expense-item.loan-given { border-left-color:var(--loan-given); }
        .expense-item.loan-taken { border-left-color:var(--loan-taken); }
        
        .status-badge { font-size:0.75rem; padding:4px 10px; border-radius:20px; }
        .status-Approved, .status-Repaid { background:rgba(16,185,129,0.2); color:#10b981; }
        .status-Rejected { background:rgba(239,68,68,0.2); color:#ef4444; }
        .status-Pending, .status-Active { background:rgba(245,158,11,0.2); color:#f59e0b; }
        
        .btn-export { background:rgba(16,185,129,0.15); color:var(--accent); padding:6px 12px; border-radius:8px; border:none; cursor:pointer; }
        .btn-check { background:rgba(16,185,129,0.2); color:#10b981; width:30px; height:30px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .action-icons { display: flex; gap: 8px; margin-left: 10px; }
        .action-icons i { cursor: pointer; color: var(--text-sub); font-size: 0.9rem; transition: color 0.2s; }
        .action-icons i.fa-pen:hover { color: var(--primary); }
        .action-icons i.fa-trash:hover { color: var(--danger); }

        .budget-wrapper { margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; }
        .budget-header { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; }
        .progress-track { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s ease; }
        .progress-fill.warning { background: #f59e0b; } .progress-fill.danger { background: #ef4444; }
        .set-budget-btn { background: none; border: none; color: var(--primary); font-size: 0.8rem; cursor: pointer; padding: 0; text-decoration: underline; }

        .search-bar-container { margin-bottom: 15px; position: relative; margin-top: 15px; }
        .search-bar { width: 100%; padding: 12px 40px 12px 15px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

        .hidden { display:none !important; }
        .step-indicator { font-size:0.8rem; color:var(--text-sub); margin-bottom:10px; text-align:right; }
    </style>
</head>
<body>

    <div id="loader-overlay" class="hidden"><div class="spinner"></div></div>

    <div class="auth-container" id="authSection">
        <div class="brand-wrapper">
            <h2 class="app-title"><i class="fa-solid fa-chart-line" style="color:var(--primary); font-size:0.8em;"></i> Vantage</h2>
            <div class="brand-subtitle">by Panav Gohil</div>
        </div>
        <div id="authContent">
            <div class="role-wrapper">
                <span class="role-label" style="font-size:0.8rem; color:var(--text-sub);">Login as</span>
                <div class="role-selector">
                    <div id="role-student" class="role-opt active" onclick="setGlobalRole('student')">Student</div>
                    <div id="role-guardian" class="role-opt" onclick="setGlobalRole('guardian')">Guardian</div>
                </div>
            </div>
            <div class="auth-tabs">
                <div id="tabLogin" class="auth-tab active" onclick="switchTab('login')">Sign In</div>
                <div id="tabRegister" class="auth-tab" onclick="switchTab('register')">Sign Up</div>
            </div>
            <div id="loginForm">
                <div class="input-group"><i class="fa-solid fa-envelope icon-left"></i><input type="email" id="l-email" placeholder="Email Address"></div>
                <div class="input-group"><i class="fa-solid fa-lock icon-left"></i><input type="password" id="l-password" placeholder="Password"><i class="fa-solid fa-eye icon-right" onclick="togglePwd('l-password')"></i></div>
                <div class="forgot-link" onclick="showReset()">Forgot Password?</div>
                <button onclick="doLogin()">Login</button>
            </div>
            <div id="registerForm" class="hidden">
                <div id="reg-step-1">
                    <div class="step-indicator">Step 1 of 3</div>
                    <div class="input-group"><i class="fa-solid fa-envelope icon-left"></i><input type="email" id="r-email" placeholder="Enter your email"></div>
                    <button onclick="sendOtp('register')">Send Verification Code</button>
                </div>
                <div id="reg-step-2" class="hidden">
                    <div class="step-indicator">Step 2 of 3</div>
                    <p style="color:var(--text-sub); text-align:center; font-size:0.9rem;">Code sent to email.</p>
                    <div class="input-group"><i class="fa-solid fa-key icon-left"></i><input type="text" id="r-otp" placeholder="Enter 4-digit Code"></div>
                    <button onclick="verifyOtp('register')">Verify Code</button>
                    <button class="secondary" onclick="resetReg()">Back</button>
                </div>
                <div id="reg-step-3" class="hidden">
                    <div class="step-indicator">Step 3 of 3</div>
                    <div class="input-group"><i class="fa-solid fa-user icon-left"></i><input type="text" id="r-name" placeholder="Full Name"></div>
                    <div class="input-group"><i class="fa-solid fa-lock icon-left"></i><input type="password" id="r-password" placeholder="Create Password"><i class="fa-solid fa-eye icon-right" onclick="togglePwd('r-password')"></i></div>
                    <div class="input-group hidden" id="r-guardian-field"><i class="fa-solid fa-link icon-left"></i><input type="text" id="r-student-key" placeholder="Student Key (Required)"></div>
                    <button onclick="doRegister()">Create Account</button>
                </div>
            </div>
        </div>
        <div id="resetForm" class="hidden">
            <h3 style="text-align:center; color:white;">Reset Password</h3>
            <div id="reset-step-1"><div class="input-group"><i class="fa-solid fa-envelope icon-left"></i><input type="email" id="reset-email" placeholder="Enter registered email"></div><button onclick="sendOtp('reset')">Send OTP</button><button class="secondary" onclick="hideReset()">Back to Login</button></div>
            <div id="reset-step-2" class="hidden"><p style="color:var(--text-sub); text-align:center; font-size:0.9rem;">Enter OTP sent to your email.</p><div class="input-group"><i class="fa-solid fa-key icon-left"></i><input type="text" id="reset-otp" placeholder="4-digit Code"></div><button onclick="verifyOtp('reset')">Verify</button><button class="secondary" onclick="hideReset()">Cancel</button></div>
            <div id="reset-step-3" class="hidden"><div class="input-group"><i class="fa-solid fa-lock icon-left"></i><input type="password" id="reset-new-pass" placeholder="New Password"><i class="fa-solid fa-eye icon-right" onclick="togglePwd('reset-new-pass')"></i></div><button onclick="doReset()">Set New Password</button></div>
        </div>
        <p id="authMsg" style="color:var(--danger); text-align:center; margin-top:15px; min-height:20px;"></p>
    </div>

    <div class="dashboard-wrapper" id="dashboardSection">
        <div class="dash-card">
            <div class="dash-header">
                <h3 id="dashTitle" style="margin:0; font-family:'Playfair Display', serif;">Dashboard</h3>
                <div class="profile-btn" id="profileBtn" onclick="toggleProfileModal()">A</div>
                
                <div id="profileModal" class="profile-modal">
                    <input type="file" id="profilePicInput" style="display:none;" accept="image/*" onchange="saveProfilePic()">
                    <div class="modal-avatar" onclick="document.getElementById('profilePicInput').click()" id="modalAvatar"><span><i class="fa-solid fa-camera"></i></span></div>
                    <p class="modal-name" id="modalName">User Name</p>
                    <p class="modal-email" id="modalEmail">user@example.com</p>
                    <div class="modal-section" id="studentSection"><span class="modal-label">Student Key</span><div class="modal-value"><span id="modalKey">STU-XXXX</span><button class="copy-btn" onclick="copyKey()"><i class="fa-regular fa-copy"></i></button></div></div>
                    <div class="modal-section">
                        <span class="modal-label">Your Password</span>
                        <div class="modal-value">
                            <span id="modalPass">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button class="copy-btn" onclick="toggleModalPwd()"><i class="fa-solid fa-eye" id="modalEye"></i></button>
                        </div>
                        <div class="input-group" style="margin-top:10px;">
                            <input type="password" id="modalNewPass" placeholder="New Password" style="padding:10px; font-size:0.85rem;">
                        </div>
                        <button style="margin-top:5px; padding:8px; font-size:0.9rem;" onclick="updatePassword()">Update Password</button>
                    </div>
                    <button class="logout-btn-modal" onclick="logout()">Sign Out</button>
                </div>
            </div>

            <div id="dashToggle" class="dash-toggle hidden">
                <div id="mode-spend" class="dash-opt active" onclick="setDashMode('spend')">Spending</div>
                <div id="mode-lend" class="dash-opt" onclick="setDashMode('lend')">Loans</div>
            </div>

            <div id="section-spend">
                <div id="studentControls" class="hidden">
                    <div style="background:#0f172a; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.05);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><h4 style="margin:0;" id="expFormTitle">Add Expense</h4><button class="text-btn" onclick="togglePastEntry()">+ Add Past Entry</button></div>
                        <div class="input-group"><i class="fa-solid fa-tag icon-left"></i><input id="expItem" placeholder="Item Name"></div>
                        <div style="display:flex; gap:10px;"><div class="input-group"><i class="fa-solid fa-indian-rupee-sign icon-left"></i><input type="number" id="expAmount" placeholder="Amount"></div><div class="input-group"><i class="fa-solid fa-list icon-left"></i><select id="expCategory" style="padding-left:45px;"><option>Essentials</option><option>Food</option><option>Travel</option><option>Study</option><option>Rent</option><option>Utilities</option><option>Health</option><option>Fashion</option><option>Entertainment</option><option>Others</option></select></div></div>
                        <div id="pastDateGroup" class="hidden" style="margin-bottom:10px;"><div class="input-group"><i class="fa-solid fa-calendar icon-left"></i><input type="date" id="expDate"></div></div>
                        <label style="color:var(--text-sub); display:flex; align-items:center; gap:10px; cursor:pointer;"><input type="checkbox" id="expReimburse" style="width:18px; margin:0;"> Request Reimbursement</label>
                        <button onclick="addExpense()" id="expBtn">Save Expense</button>
                    </div>
                </div>
                
                <div class="budget-wrapper hidden" id="budgetCard">
                    <div class="budget-header"><span>Monthly Budget: <strong id="budgetDisplay">‚Çπ0</strong></span><button class="set-budget-btn" onclick="promptBudget()">Set Limit</button></div>
                    <div class="progress-track"><div class="progress-fill" id="budgetBar"></div></div>
                    <div style="font-size:0.75rem; color:#666; margin-top:5px; text-align:right;" id="budgetText">0% used</div>
                </div>

                <div style="display:flex; justify-content:space-between; margin-bottom:10px; margin-top:20px;"><h4>Recent Activity</h4><button class="btn-export" onclick="exportToExcel()"><i class="fa-solid fa-download"></i> CSV</button></div>
                <div class="search-bar-container"><input type="text" class="search-bar" id="searchInput" placeholder="Search..." onkeyup="filterExpenses()"><i class="fa-solid fa-magnifying-glass search-icon"></i></div>
                <div id="expenseList">Loading...</div>
            </div>

            <div id="section-lend" class="hidden">
                <div style="background:#0f172a; padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid var(--loan-given);" id="loanFormContainer">
                    <h4 style="margin:0 0 10px 0; color:var(--loan-given);" id="loanFormTitle">Record Loan Given</h4>
                    <div class="input-group"><i class="fa-solid fa-user-group icon-left"></i><input id="loanName" placeholder="Friend's Name"></div>
                    <div class="input-group" id="loanKeyGroup"><i class="fa-solid fa-key icon-left"></i><input id="loanFriendKey" placeholder="Friend's Student Key (Optional)"></div>
                    <div class="input-group"><i class="fa-solid fa-calendar icon-left"></i><input type="date" id="loanDate"></div>
                    <div class="input-group"><i class="fa-solid fa-indian-rupee-sign icon-left"></i><input type="number" id="loanAmount" placeholder="Amount Given"></div>
                    <div class="input-group"><i class="fa-solid fa-note-sticky icon-left"></i><input id="loanRemarks" placeholder="Remarks/Notes (Optional)"></div>
                    <button style="background:var(--loan-given);" onclick="addLoan()" id="loanBtn">Record Loan</button>
                </div>
                
                <div class="loan-tabs">
                    <div id="tab-given" class="loan-tab active" onclick="switchLoanTab('given')">Money Given</div>
                    <div id="tab-taken" class="loan-tab" onclick="switchLoanTab('taken')">Money Taken</div>
                </div>

                <div id="loanList">Loading...</div>
            </div>
        </div>

        <div class="dash-card">
            <div class="total-card"><span id="totalLabel" style="opacity:0.8; font-size:0.9rem;">TOTAL SPENT</span><span class="total-amount" id="grandTotal">‚Çπ0</span></div>
            <h4 style="text-align:center;">Analysis</h4>
            <div style="height:250px; position:relative;"><canvas id="expenseChart"></canvas></div>
            <div id="chartLegend" style="margin-top:20px;"></div>
        </div>
    </div>

    <script>
        // REPLACE WITH YOUR URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbyd08MNdcJpKM18aVberZk8tCFhu_NzXxbDDq1pTXr7u7_h6ewYGt8ILfVtK5e8G_c/exec'; 

        let currentRole = 'student', currentUser = null, currentExpenses = [], myChart = null;
        let givenLoans = [], takenLoans = [], activeLoanTab = 'given';
        let editingExpenseId = null, editingLoanId = null;

        const loader = { show: () => document.getElementById('loader-overlay').classList.remove('hidden'), hide: () => document.getElementById('loader-overlay').classList.add('hidden') };
        const msg = (text) => document.getElementById('authMsg').innerText = text;

        function setGlobalRole(r) { currentRole = r; document.getElementById('role-student').classList.toggle('active', r==='student'); document.getElementById('role-guardian').classList.toggle('active', r==='guardian'); document.getElementById('r-guardian-field').classList.toggle('hidden', r!=='guardian'); msg(""); }
        function switchTab(t) { document.getElementById('tabLogin').classList.toggle('active', t==='login'); document.getElementById('tabRegister').classList.toggle('active', t==='register'); document.getElementById('loginForm').classList.toggle('hidden', t!=='login'); document.getElementById('registerForm').classList.toggle('hidden', t!=='register'); msg(""); }
        function resetReg() { document.getElementById('reg-step-1').classList.remove('hidden'); document.getElementById('reg-step-2').classList.add('hidden'); document.getElementById('reg-step-3').classList.add('hidden'); msg(""); }
        function togglePwd(id) { const x = document.getElementById(id); x.type = (x.type === "password") ? "text" : "password"; }
        function showReset() { document.getElementById('authContent').classList.add('hidden'); document.getElementById('resetForm').classList.remove('hidden'); msg(""); }
        function hideReset() { document.getElementById('authContent').classList.remove('hidden'); document.getElementById('resetForm').classList.add('hidden'); resetResetFlow(); msg(""); }
        function resetResetFlow() { document.getElementById('reset-step-1').classList.remove('hidden'); document.getElementById('reset-step-2').classList.add('hidden'); document.getElementById('reset-step-3').classList.add('hidden'); }

        async function apiCall(data) { loader.show(); try { const res = await fetch(API_URL, {method:'POST', body:JSON.stringify(data)}); const json = await res.json(); loader.hide(); return json; } catch(e) { loader.hide(); alert("Connection Error"); return {status:'error'}; } }
        async function doLogin() { const email = document.getElementById('l-email').value, pass = document.getElementById('l-password').value; if(!email||!pass) return msg("Enter credentials"); const res = await apiCall({ action:'login', role:currentRole, email:email, password:pass }); if(res.status==='success') { localStorage.setItem('vantageUser', JSON.stringify({...res.data, role:currentRole})); loadDashboard({...res.data, role:currentRole}); } else msg(res.message); }
        async function doRegister() { const email = document.getElementById('r-email').value, pass = document.getElementById('r-password').value, name = document.getElementById('r-name').value, key = document.getElementById('r-student-key').value; if(!name||!pass) return msg("Fill all fields"); if(currentRole==='guardian' && !key) return msg("Enter Student Key"); const action = currentRole==='student'?'register_student':'register_guardian'; const res = await apiCall({ action:action, email:email, password:pass, name:name, studentKeys:key }); if(res.status==='success') { alert(currentRole==='student'?"Account Created! Check email for key.":"Account Created!"); switchTab('login'); resetReg(); } else msg(res.message); }
        async function sendOtp(flow) { const emailId = flow === 'register' ? 'r-email' : 'reset-email'; const email = document.getElementById(emailId).value; if(!email) return msg("Enter email"); msg("Sending OTP..."); const res = await apiCall({ action:'send_otp', email:email }); if(res.status==='success') { msg(""); if(flow==='register') { document.getElementById('reg-step-1').classList.add('hidden'); document.getElementById('reg-step-2').classList.remove('hidden'); } else { document.getElementById('reset-step-1').classList.add('hidden'); document.getElementById('reset-step-2').classList.remove('hidden'); } } else msg("Error"); }
        async function verifyOtp(flow) { const emailId = flow === 'register' ? 'r-email' : 'reset-email'; const otpId = flow === 'register' ? 'r-otp' : 'reset-otp'; const res = await apiCall({ action:'verify_otp', email:document.getElementById(emailId).value, otp:document.getElementById(otpId).value }); if(res.status==='success') { msg(""); if(flow==='register') { document.getElementById('reg-step-2').classList.add('hidden'); document.getElementById('reg-step-3').classList.remove('hidden'); } else { document.getElementById('reset-step-2').classList.add('hidden'); document.getElementById('reset-step-3').classList.remove('hidden'); } } else msg("Invalid OTP"); }
        async function doReset() { const email = document.getElementById('reset-email').value, pass = document.getElementById('reset-new-pass').value; if(!pass) return msg("Enter new password"); const res = await apiCall({ action: 'reset_password', email: email, password: pass }); if(res.status === 'success') { alert("Password Reset Successful! Login now."); hideReset(); } else msg(res.message); }

        window.onload = function() { const saved = localStorage.getItem('vantageUser'); if(saved) loadDashboard(JSON.parse(saved)); };
        function logout() { localStorage.removeItem('vantageUser'); location.reload(); }

        function loadDashboard(user) {
            currentUser = user; document.getElementById('authSection').style.display='none'; document.getElementById('dashboardSection').style.display='grid';
            document.getElementById('dashTitle').innerText = `Hi, ${user.name.split(' ')[0]}`;
            const btn = document.getElementById('profileBtn'), modalAvatar = document.getElementById('modalAvatar');
            btn.innerText = user.name.charAt(0).toUpperCase(); btn.style.backgroundImage = 'none'; modalAvatar.style.backgroundImage = 'none'; modalAvatar.innerHTML = '<span><i class="fa-solid fa-camera"></i></span>';
            const uniqueKey = 'vantageProfilePic_' + user.email; const savedPic = localStorage.getItem(uniqueKey);
            if(savedPic) { btn.style.backgroundImage = `url(${savedPic})`; btn.innerText = ""; modalAvatar.style.backgroundImage = `url(${savedPic})`; modalAvatar.innerHTML = ""; }
            
            if(user.role === 'student') { 
                document.getElementById('studentControls').classList.remove('hidden'); 
                document.getElementById('dashToggle').classList.remove('hidden'); 
                document.getElementById('budgetCard').classList.remove('hidden'); 
                updateBudgetUI(user.budget||0, 0); 
                fetchData(user.student_key, 'get_expenses'); 
            } else { 
                document.getElementById('studentControls').classList.add('hidden'); 
                document.getElementById('dashToggle').classList.add('hidden'); 
                document.getElementById('budgetCard').classList.add('hidden'); 
                fetchData(user.email, 'get_guardian_data'); 
            }
        }

        function setDashMode(mode) {
            document.getElementById('mode-spend').classList.toggle('active', mode==='spend');
            document.getElementById('mode-lend').classList.toggle('active', mode==='lend');
            document.getElementById('section-spend').classList.toggle('hidden', mode!=='spend');
            document.getElementById('section-lend').classList.toggle('hidden', mode!=='lend');
            if(mode === 'lend') fetchLoans();
            else { renderStats(currentExpenses); } 
        }

        function switchLoanTab(type) {
            activeLoanTab = type;
            document.getElementById('tab-given').classList.toggle('active', type==='given');
            document.getElementById('tab-taken').classList.toggle('active', type==='taken');
            
            editingLoanId = null;
            document.getElementById('loanBtn').innerText = type === 'given' ? "Record Loan Given" : "Record Debt";
            
            const container = document.getElementById('loanFormContainer'), title = document.getElementById('loanFormTitle');
            const nameInput = document.getElementById('loanName'), keyInput = document.getElementById('loanFriendKey');
            const amtInput = document.getElementById('loanAmount'), btn = document.getElementById('loanBtn');

            if(type === 'given') {
                container.style.borderColor = 'var(--loan-given)'; title.style.color = 'var(--loan-given)'; title.innerText = 'Record Loan Given';
                nameInput.placeholder = "Friend's Name"; keyInput.placeholder = "Friend's Student Key (Optional)"; amtInput.placeholder = "Amount Given";
                btn.style.backgroundColor = 'var(--loan-given)';
            } else {
                container.style.borderColor = 'var(--loan-taken)'; title.style.color = 'var(--loan-taken)'; title.innerText = 'Record Debt (Money Taken)';
                nameInput.placeholder = "Lender's Name"; keyInput.placeholder = "Lender's Student Key (Optional)"; amtInput.placeholder = "Amount Borrowed";
                btn.style.backgroundColor = 'var(--loan-taken)';
            }
            renderLoanList(); renderLoanStats();
        }

        function togglePastEntry() {
            const group = document.getElementById('pastDateGroup'); group.classList.toggle('hidden');
            const btn = document.querySelector('.text-btn');
            if(!group.classList.contains('hidden')) { btn.innerText = "Cancel Past Entry"; btn.style.color = "#ef4444"; } 
            else { btn.innerText = "+ Add Past Entry"; btn.style.color = "#3b82f6"; document.getElementById('expDate').value = ""; }
        }

        async function promptBudget() {
            const newBudget = prompt("Enter monthly budget (‚Çπ):", currentUser.budget || 0);
            if(newBudget && !isNaN(newBudget)) {
                currentUser.budget = parseInt(newBudget);
                localStorage.setItem('vantageUser', JSON.stringify(currentUser));
                updateBudgetUI(currentUser.budget, calculateTotalSpent());
                const id = currentUser.role === 'student' ? currentUser.student_key : currentUser.email;
                await apiCall({ action: 'update_budget', role: currentUser.role, [currentUser.role === 'student' ? 'student_key' : 'email']: id, budget: newBudget });
            }
        }

        function updateBudgetUI(limit, spent) {
            document.getElementById('budgetDisplay').innerText = `‚Çπ${parseInt(limit).toLocaleString()}`;
            if(limit <= 0) { document.getElementById('budgetBar').style.width = '0%'; return; }
            let pct = (spent / limit) * 100;
            const bar = document.getElementById('budgetBar');
            bar.style.width = `${Math.min(pct, 100)}%`;
            bar.className = 'progress-fill';
            if(pct > 90) bar.classList.add('danger'); else if(pct > 75) bar.classList.add('warning');
            document.getElementById('budgetText').innerText = `${Math.round(pct)}% used of ‚Çπ${limit}`;
        }

        function calculateTotalSpent() { return currentExpenses.reduce((sum, item) => sum + Number(item.amount), 0); }

        async function addExpense() {
            const dateInput = document.getElementById('expDate').value;
            const payload = { 
                student_key:currentUser.student_key, 
                item_name:document.getElementById('expItem').value, 
                amount:document.getElementById('expAmount').value, 
                category:document.getElementById('expCategory').value, 
                is_reimbursable:document.getElementById('expReimburse').checked 
            };
            if(dateInput) payload.date = dateInput;
            if(editingExpenseId) { payload.action = 'update_expense'; payload.id = editingExpenseId; } 
            else { payload.action = 'add_expense'; }
            await apiCall(payload);
            editingExpenseId = null; document.getElementById('expBtn').innerText = "Save Expense"; document.getElementById('expFormTitle').innerText = "Add Expense";
            document.getElementById('expItem').value=""; document.getElementById('expAmount').value=""; document.getElementById('expDate').value="";
            if(!document.getElementById('pastDateGroup').classList.contains('hidden')) togglePastEntry();
            fetchData(currentUser.student_key, 'get_expenses');
        }

        async function addLoan() {
            const name = document.getElementById('loanName').value, amount = document.getElementById('loanAmount').value, date = document.getElementById('loanDate').value;
            const friendKey = document.getElementById('loanFriendKey').value, remarks = document.getElementById('loanRemarks').value;
            if(!name || !amount) return alert("Fill details");
            const payload = {
                student_key:currentUser.student_key, friend_name:name, amount:amount, date:date, 
                borrower_key: friendKey, remarks: remarks, loan_type: activeLoanTab 
            };
            if(editingLoanId) { payload.action = 'update_loan'; payload.id = editingLoanId; } 
            else { payload.action = 'add_loan'; }
            await apiCall(payload);
            editingLoanId = null;
            document.getElementById('loanName').value=""; document.getElementById('loanAmount').value=""; document.getElementById('loanFriendKey').value=""; document.getElementById('loanRemarks').value="";
            fetchLoans();
        }

        function startEditExpense(id) {
            const exp = currentExpenses.find(e => e.id === id); if(!exp) return;
            editingExpenseId = id; document.getElementById('expFormTitle').innerText = "Edit Expense"; document.getElementById('expBtn').innerText = "Update Expense";
            document.getElementById('expItem').value = exp.item; document.getElementById('expAmount').value = exp.amount;
            document.getElementById('expCategory').value = exp.category; document.getElementById('expReimburse').checked = exp.reimbursable;
            document.getElementById('pastDateGroup').classList.remove('hidden');
            const d = new Date(exp.date); document.getElementById('expDate').value = d.toISOString().split('T')[0];
            document.querySelector('.text-btn').innerText = "Cancel Edit"; document.querySelector('.text-btn').style.color = "#ef4444";
            document.getElementById('studentControls').scrollIntoView({behavior: "smooth"});
        }

        function startEditLoan(id) {
            const loans = activeLoanTab === 'given' ? givenLoans : takenLoans;
            const l = loans.find(x => x.id === id); if(!l) return;
            editingLoanId = id; document.getElementById('loanFormTitle').innerText = "Edit Loan"; document.getElementById('loanBtn').innerText = "Update Loan";
            document.getElementById('loanName').value = l.friend; document.getElementById('loanAmount').value = l.amount; document.getElementById('loanRemarks').value = l.remarks || "";
            const d = new Date(l.date); document.getElementById('loanDate').value = d.toISOString().split('T')[0];
            document.getElementById('loanFormContainer').scrollIntoView({behavior: "smooth"});
        }

        async function deleteItem(id, type) {
            if(!confirm("Are you sure you want to delete this?")) return;
            await apiCall({ action: 'delete_item', id: id, type: type });
            if(type === 'expense') fetchData(currentUser.student_key, 'get_expenses'); else fetchLoans();
        }

        async function updateStatus(id, stat) { await apiCall({ action:'update_status', expense_id:id, new_status:stat }); fetchData(currentUser.email, 'get_guardian_data'); }
        
        async function settleLoan(id, totalAmt) { 
            const input = prompt(`Total Owed: ‚Çπ${totalAmt}\nEnter amount paid (or leave empty for Full Settle):`);
            if(input === null) return; // Cancel
            const payload = { action:'settle_loan', loan_id:id };
            if(input.trim() !== "") payload.partial_amount = input;
            await apiCall(payload); fetchLoans(); 
        }

        async function fetchData(id, action) {
            const res = await apiCall({ action:action, [action==='get_expenses'?'student_key':'email']:id });
            currentExpenses = res.expenses || []; currentExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderList(currentExpenses); renderStats(currentExpenses);
        }
        
        async function fetchLoans() {
            const res = await apiCall({ action:'get_loans', student_key:currentUser.student_key });
            givenLoans = res.given || []; takenLoans = res.taken || [];
            renderLoanList(); renderLoanStats();
        }

        function renderLoanList() {
            const list = document.getElementById('loanList'); list.innerHTML="";
            const items = activeLoanTab === 'given' ? givenLoans : takenLoans;
            if(!items.length) return list.innerHTML="<p style='color:#666'>No records.</p>";
            items.reverse().forEach(l => {
                const nameLabel = activeLoanTab === 'given' ? l.friend : `Lender: ${l.friend}`;
                const isRepaid = l.status === 'Repaid';
                // Button logic for Partial/Full
                const btn = (activeLoanTab === 'given' && !isRepaid) ? `<button class="btn-check" onclick="settleLoan('${l.id}', '${l.amount}')"><i class="fa fa-check"></i></button>` : '';
                const cssClass = activeLoanTab === 'given' ? 'loan-given' : 'loan-taken';
                const actions = `<div class="action-icons"><i class="fa-solid fa-pen" onclick="startEditLoan('${l.id}')"></i><i class="fa-solid fa-trash" onclick="deleteItem('${l.id}', 'loan')"></i></div>`;
                const remarksHTML = l.remarks ? `<div style="font-size:0.75rem; color:#666; margin-top:4px;">NOTE: ${l.remarks}</div>` : '';
                list.innerHTML += `<div class="expense-item ${cssClass}"><div><strong>${nameLabel}</strong><br><span style="color:#888;font-size:0.8rem">${new Date(l.date).toLocaleDateString()}</span>${remarksHTML}</div><div style="text-align:right; display:flex; gap:10px; align-items:center;"><strong>‚Çπ${l.amount}</strong><span class="status-badge status-${l.status}">${l.status}</span>${btn}${actions}</div></div>`;
            });
        }

        function renderList(items) {
            const list = document.getElementById('expenseList'); list.innerHTML=""; if(!items.length) return list.innerHTML="<p style='text-align:center;color:#666'>No records.</p>";
            let lastMonth = "";
            items.forEach(i => {
                const d = new Date(i.date); const m = d.toLocaleDateString('default', { month: 'long', year: 'numeric' });
                if(m !== lastMonth) { list.innerHTML += `<div class="month-header">${m}</div>`; lastMonth = m; }
                let btns = (currentUser.role === 'guardian' && i.status === 'Pending') ? `<div style="margin-top:5px;"><button onclick="updateStatus('${i.id}','Approved')" style="width:30px;padding:5px;margin-right:5px;background:rgba(16,185,129,0.2);color:#10b981"><i class="fa fa-check"></i></button><button onclick="updateStatus('${i.id}','Rejected')" style="width:30px;padding:5px;background:rgba(239,68,68,0.2);color:#ef4444"><i class="fa fa-times"></i></button></div>` : '';
                let actions = "";
                if(currentUser.role === 'student') { actions = `<div class="action-icons"><i class="fa-solid fa-pen" onclick="startEditExpense('${i.id}')"></i><i class="fa-solid fa-trash" onclick="deleteItem('${i.id}', 'expense')"></i></div>`; }
                list.innerHTML += `<div class="expense-item ${i.reimbursable||currentUser.role==='guardian'?'reimburse':''}"><div><strong>${escapeHTML(i.item)}</strong><div style="font-size:0.8rem;color:#888">${currentUser.role==='guardian'?i.studentName:i.category} ‚Ä¢ ${d.toLocaleDateString()}</div></div><div style="text-align:right"><strong>‚Çπ${i.amount}</strong><br>${(i.reimbursable||currentUser.role==='guardian')?`<span class="status-badge status-${i.status}">${i.status}</span>`:''}${btns}${actions}</div></div>`;
            });
        }

        function filterExpenses() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = currentExpenses.filter(e => (e.item && e.item.toLowerCase().includes(term)) || (e.category && e.category.toLowerCase().includes(term)) || (e.amount && e.amount.toString().includes(term)));
            renderList(filtered);
        }

        function renderStats(items) {
            let total=0; const cats={}; const isGuardian = currentUser.role === 'guardian';
            const targetItems = isGuardian ? items.filter(i => i.status === 'Pending') : items;
            targetItems.forEach(i => { total += +i.amount; cats[i.category||'Misc']=(cats[i.category||'Misc']||0)+ +i.amount; });
            const labelEl = document.getElementById('totalLabel'); if(labelEl) labelEl.innerText = isGuardian ? "ACTIVE REQUESTS" : "TOTAL SPENT";
            document.getElementById('grandTotal').innerText = `‚Çπ${total.toLocaleString()}`;
            if(!isGuardian) updateBudgetUI(currentUser.budget || 0, total);
            
            if(myChart) myChart.destroy();
            const ctx = document.getElementById('expenseChart'); const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f43f5e', '#64748b'];
            myChart = new Chart(ctx, { type:'doughnut', data: { labels:Object.keys(cats), datasets:[{data:Object.values(cats), backgroundColor:colors, borderWidth:0}] }, options:{plugins:{legend:{display:false}}} });
            document.getElementById('chartLegend').innerHTML = Object.keys(cats).map((c,i) => `<div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9rem"><span style="color:${colors[i%colors.length]}">‚óè ${c}</span><span>‚Çπ${cats[c]}</span></div>`).join('');
        }

        function renderLoanStats() {
            let totalUnpaid = 0; const people = {};
            const items = activeLoanTab === 'given' ? givenLoans : takenLoans;
            items.forEach(l => {
                if(l.status !== 'Repaid') {
                    totalUnpaid += +l.amount;
                    people[l.friend] = (people[l.friend] || 0) + +l.amount;
                }
            });
            document.getElementById('grandTotal').innerText = `‚Çπ${totalUnpaid.toLocaleString()}`;
            document.getElementById('totalLabel').innerText = activeLoanTab === 'given' ? "TOTAL OWED TO ME" : "TOTAL DEBT I OWE";
            if(myChart) myChart.destroy();
            const ctx = document.getElementById('expenseChart');
            const colors = activeLoanTab === 'given' ? ['#8b5cf6','#a78bfa','#c4b5fd'] : ['#f97316','#fb923c','#fdba74'];
            myChart = new Chart(ctx, { type:'doughnut', data: { labels:Object.keys(people), datasets:[{data:Object.values(people), backgroundColor:colors, borderWidth:0}] }, options:{plugins:{legend:{display:false}}} });
            document.getElementById('chartLegend').innerHTML = Object.keys(people).map((c,i) => `<div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9rem"><span style="color:${colors[i%colors.length]}">‚óè ${c}</span><span>‚Çπ${people[c]}</span></div>`).join('');
        }

        function escapeHTML(str) { if(!str) return ''; return str.toString().replace(/[&<>"']/g, function(m) { return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m]; }); }
        
        function toggleProfileModal() { const m = document.getElementById('profileModal'); m.classList.toggle('show'); if(m.classList.contains('show')) { document.getElementById('modalName').innerText = currentUser.name; document.getElementById('modalEmail').innerText = currentUser.email; if(currentUser.role === 'student') { document.getElementById('studentSection').classList.remove('hidden'); document.getElementById('modalKey').innerText = currentUser.student_key; } else { document.getElementById('studentSection').classList.add('hidden'); } } }
        function saveProfilePic() { const file = document.getElementById('profilePicInput').files[0]; const reader = new FileReader(); reader.onloadend = function() { const uniqueKey = 'vantageProfilePic_' + currentUser.email; localStorage.setItem(uniqueKey, reader.result); document.getElementById('profileBtn').style.backgroundImage = `url(${reader.result})`; document.getElementById('profileBtn').innerText = ""; document.getElementById('modalAvatar').style.backgroundImage = `url(${reader.result})`; document.getElementById('modalAvatar').innerHTML = ""; }; if(file) reader.readAsDataURL(file); }
        function toggleModalPwd() { const span = document.getElementById('modalPass'); const eye = document.getElementById('modalEye'); if(span.innerText === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') { span.innerText = currentUser.password; eye.classList.remove('fa-eye'); eye.classList.add('fa-eye-slash'); } else { span.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; eye.classList.remove('fa-eye-slash'); eye.classList.add('fa-eye'); } }
        async function updatePassword() { const newPass = document.getElementById('modalNewPass').value; if(!newPass) return alert("Enter password"); const res = await apiCall({ action: 'reset_password', email: currentUser.email, password: newPass }); if(res.status === 'success') { alert("Updated!"); currentUser.password = newPass; localStorage.setItem('vantageUser', JSON.stringify(currentUser)); document.getElementById('modalNewPass').value=""; toggleModalPwd(); } else alert(res.message); }
        function copyKey() { navigator.clipboard.writeText(currentUser.student_key); alert("Copied!"); }
        window.onclick = function(event) { if (!event.target.matches('.profile-btn') && !event.target.closest('.profile-modal')) { document.getElementById('profileModal').classList.remove('show'); } }
    </script>
</body>
</html>
